<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>FitNotes Lite</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f6f6f6;
      color: #333;
    }
    header {
      background-color: #161b23;
      color: #fff;
      padding: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    nav {
      display: flex;
      gap: 1rem;
    }
    nav button {
      background: none;
      border: none;
      color: #fff;
      font-size: 1rem;
      cursor: pointer;
      padding: 0.5rem 1rem;
    }
    nav button.active {
      border-bottom: 2px solid #fff;
    }
    main {
      padding: 1rem;
    }
    .hidden {
      display: none;
    }
    .section {
      margin-top: 1rem;
    }
    label {
      display: block;
      margin-top: 0.5rem;
    }
    input,
    select {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.25rem;
      box-sizing: border-box;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th,
    td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: left;
    }
    .btn {
      padding: 0.5rem 1rem;
      margin-top: 0.5rem;
      background-color: #3490dc;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
    }
    .btn.danger {
      background-color: #e3342f;
    }
    .btn.secondary {
      background-color: #6c757d;
    }
    .set-card {
      border: 1px solid #ddd;
      background: #fff;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .set-card .info {
      flex-grow: 1;
    }
    .set-card .actions {
      margin-left: 0.5rem;
    }
    .set-card button {
      margin-left: 0.25rem;
    }
    .notice {
      padding: 0.5rem;
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      margin-top: 1rem;
    }
    ul {
      list-style: none;
      padding-left: 0;
    }

    /*
      Responsive tweaks for small screens (like iPhone).
      On narrow viewports we stack the header elements, make the
      navigation bar wrap into two rows, and ensure buttons and
      controls span the available width. We also slightly reduce
      font sizes so everything fits comfortably.
    */
    @media (max-width: 600px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      nav {
        width: 100%;
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      nav button {
        flex: 1 1 48%;
        text-align: center;
        padding: 0.5rem;
        font-size: 0.9rem;
      }
      main {
        padding: 0.5rem;
      }
      h1 {
        font-size: 1.5rem;
      }
      h2 {
        font-size: 1.2rem;
      }
      h3 {
        font-size: 1.1rem;
      }
      .btn {
        width: 100%;
        box-sizing: border-box;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>FitNotes Lite</h1>
    <nav>
      <button data-section="today" class="active">Today</button>
      <button data-section="history">History</button>
      <button data-section="exercises">Exercises</button>
      <button data-section="settings">Settings</button>
    </nav>
  </header>
  <main>
    <!-- Today section -->
    <section id="today" class="section">
      <h2>Today's Workout (<span id="today-date"></span>)</h2>
      <div id="today-sets"></div>
      <h3>Add Set</h3>
      <label for="new-exercise">Exercise</label>
      <select id="new-exercise"></select>
      <label for="new-weight">Weight</label>
      <input type="number" id="new-weight" step="0.1">
      <label for="new-reps">Reps</label>
      <input type="number" id="new-reps">
      <label for="new-rpe">RPE (optional)</label>
      <input type="number" id="new-rpe" step="0.1">
      <button id="add-set" class="btn">Add Set</button>
    </section>

    <!-- History section -->
    <section id="history" class="section hidden">
      <h2>History</h2>
      <div id="history-filters">
        <label for="history-exercise-filter">Filter by Exercise</label>
        <select id="history-exercise-filter"></select>
      </div>
      <div id="history-list"></div>
    </section>

    <!-- Exercises section -->
    <section id="exercises" class="section hidden">
      <h2>Exercises</h2>
      <ul id="exercise-list"></ul>
      <h3>Add Exercise</h3>
      <label for="new-exercise-name">Name</label>
      <input id="new-exercise-name" type="text">
      <button id="add-exercise" class="btn">Add Exercise</button>
    </section>

    <!-- Settings section -->
    <section id="settings" class="section hidden">
      <h2>Settings</h2>
      <div>
        <label for="unit-select">Weight Unit</label>
        <select id="unit-select">
          <option value="kg">kg</option>
          <option value="lb">lb</option>
        </select>
      </div>
      <div class="notice">Backup your data regularly!</div>
      <h3>Backup &amp; Restore</h3>
      <button id="export-data" class="btn">Export Backup (JSON)</button>
      <label for="import-data">Import Backup (JSON)</label>
      <input id="import-data" type="file" accept=".json">
      <label for="import-csv">Import CSV (FitNotes export)</label>
      <input id="import-csv" type="file" accept=".csv">
      <button id="clear-data" class="btn danger">Reset All Data</button>
    </section>
  </main>

  <script>
    /*
      FitNotes Lite: A simple workout tracker inspired by FitNotes.
      This version persists workouts, exercises and settings in localStorage.
      New in this version:
      - CSV import: import a FitNotes CSV export and merge into existing data.
      - History shows workouts grouped by date, so you can review full sessions.
    */
    // Default data structure
    const defaultData = {
      settings: { unit: 'kg' },
      exercises: [],
      workouts: []
    };
    let data;

    function loadData() {
      try {
        const raw = localStorage.getItem('fitnotesLite');
        if (raw) {
          data = JSON.parse(raw);
          // ensure data has required fields
          if (!data.settings) data.settings = { unit: 'kg' };
          if (!Array.isArray(data.exercises)) data.exercises = [];
          if (!Array.isArray(data.workouts)) data.workouts = [];
        } else {
          data = JSON.parse(JSON.stringify(defaultData));
          saveData();
        }
      } catch (e) {
        console.error(e);
        data = JSON.parse(JSON.stringify(defaultData));
        saveData();
      }
    }

    function saveData() {
      localStorage.setItem('fitnotesLite', JSON.stringify(data));
    }

    // Generate a simple random ID
    function uuid() {
      return 'xxxxxx'.replace(/[x]/g, () => (Math.random() * 36 | 0).toString(36));
    }

    // Re-render everything
    function updateAll() {
      updateSettings();
      updateExercisesList();
      updateToday();
      updateHistory();
    }

    // Settings UI
    function updateSettings() {
      document.getElementById('unit-select').value = data.settings.unit || 'kg';
    }

    document.getElementById('unit-select').addEventListener('change', e => {
      data.settings.unit = e.target.value;
      saveData();
      updateToday();
      updateHistory();
    });

    // Exercises UI
    function updateExercisesList() {
      const list = document.getElementById('exercise-list');
      list.innerHTML = '';
      data.exercises.forEach(ex => {
        const li = document.createElement('li');
        li.textContent = ex.name;
        // Rename button
        const renameBtn = document.createElement('button');
        renameBtn.textContent = 'Rename';
        renameBtn.className = 'btn secondary';
        renameBtn.onclick = () => {
          const newName = prompt('Rename exercise', ex.name);
          if (newName) {
            ex.name = newName.trim();
            saveData();
            updateExercisesList();
            updateToday();
            updateHistory();
          }
        };
        // Delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Delete';
        deleteBtn.className = 'btn danger';
        deleteBtn.onclick = () => {
          if (confirm('Delete exercise and all associated sets?')) {
            // Remove sets referencing this exercise
            data.workouts.forEach(w => {
              w.sets = w.sets.filter(s => s.exerciseId !== ex.id);
            });
            // Remove exercise
            data.exercises = data.exercises.filter(e => e.id !== ex.id);
            saveData();
            updateExercisesList();
            updateToday();
            updateHistory();
          }
        };
        li.appendChild(renameBtn);
        li.appendChild(deleteBtn);
        list.appendChild(li);
      });
      // Update exercise selects
      const exSelect = document.getElementById('new-exercise');
      const filterSelect = document.getElementById('history-exercise-filter');
      exSelect.innerHTML = '';
      filterSelect.innerHTML = '<option value="">All Exercises</option>';
      data.exercises.forEach(ex => {
        const opt = document.createElement('option');
        opt.value = ex.id;
        opt.textContent = ex.name;
        exSelect.appendChild(opt);
        const opt2 = document.createElement('option');
        opt2.value = ex.id;
        opt2.textContent = ex.name;
        filterSelect.appendChild(opt2);
      });
    }

    document.getElementById('add-exercise').addEventListener('click', () => {
      const name = document.getElementById('new-exercise-name').value.trim();
      if (name) {
        const newExercise = { id: uuid(), name: name };
        data.exercises.push(newExercise);
        document.getElementById('new-exercise-name').value = '';
        saveData();
        updateExercisesList();
        updateToday();
        updateHistory();
      }
    });

    // Today's workout UI
    function updateToday() {
      const todaySetsDiv = document.getElementById('today-sets');
      const todayDateSpan = document.getElementById('today-date');
      const todayDate = new Date().toISOString().slice(0, 10);
      todayDateSpan.textContent = todayDate;
      // find or create today's workout
      let workout = data.workouts.find(w => w.date === todayDate);
      if (!workout) {
        workout = { id: uuid(), date: todayDate, notes: '', sets: [] };
        data.workouts.push(workout);
        saveData();
      }
      todaySetsDiv.innerHTML = '';
      workout.sets.forEach(set => {
        const exercise = data.exercises.find(e => e.id === set.exerciseId) || { name: 'Deleted' };
        const card = document.createElement('div');
        card.className = 'set-card';
        const info = document.createElement('div');
        info.className = 'info';
        info.textContent = `${exercise.name} - ${set.weight}${data.settings.unit} × ${set.reps}${set.rpe ? ' @ RPE ' + set.rpe : ''}`;
        card.appendChild(info);
        const actions = document.createElement('div');
        actions.className = 'actions';
        // Duplicate button
        const dup = document.createElement('button');
        dup.textContent = 'Duplicate';
        dup.className = 'btn secondary';
        dup.onclick = () => {
          const newSet = { ...set, id: uuid() };
          workout.sets.push(newSet);
          saveData();
          updateToday();
        };
        actions.appendChild(dup);
        // Delete button
        const del = document.createElement('button');
        del.textContent = 'Delete';
        del.className = 'btn danger';
        del.onclick = () => {
          workout.sets = workout.sets.filter(s => s.id !== set.id);
          saveData();
          updateToday();
        };
        actions.appendChild(del);
        card.appendChild(actions);
        todaySetsDiv.appendChild(card);
      });
    }

    document.getElementById('add-set').addEventListener('click', () => {
      const exId = document.getElementById('new-exercise').value;
      const weight = parseFloat(document.getElementById('new-weight').value);
      const reps = parseInt(document.getElementById('new-reps').value);
      const rpeVal = parseFloat(document.getElementById('new-rpe').value);
      if (!exId) { alert('Select an exercise'); return; }
      if (isNaN(weight) || isNaN(reps)) { alert('Enter weight and reps'); return; }
      const todayDate = new Date().toISOString().slice(0, 10);
      const workout = data.workouts.find(w => w.date === todayDate);
      if (!workout) return;
      const newSet = { id: uuid(), exerciseId: exId, weight: weight, reps: reps };
      if (!isNaN(rpeVal)) newSet.rpe = rpeVal;
      workout.sets.push(newSet);
      document.getElementById('new-weight').value = '';
      document.getElementById('new-reps').value = '';
      document.getElementById('new-rpe').value = '';
      saveData();
      updateToday();
      updateHistory();
    });

    // History UI
    function updateHistory() {
      const filter = document.getElementById('history-exercise-filter').value;
      const container = document.getElementById('history-list');
      container.innerHTML = '';
      // Sort workouts by date descending
      const workoutsSorted = [...data.workouts].sort((a, b) => b.date.localeCompare(a.date));
      workoutsSorted.forEach(workout => {
        // Filter sets by exercise if a filter is selected
        const sets = filter ? workout.sets.filter(s => s.exerciseId === filter) : workout.sets;
        if (sets.length === 0) return;
        const div = document.createElement('div');
        div.className = 'history-workout';
        const h3 = document.createElement('h3');
        h3.textContent = workout.date;
        div.appendChild(h3);
        const ul = document.createElement('ul');
        sets.forEach(set => {
          const exercise = data.exercises.find(e => e.id === set.exerciseId) || { name: 'Deleted' };
          const li = document.createElement('li');
          li.textContent = `${exercise.name} - ${set.weight}${data.settings.unit} × ${set.reps}${set.rpe ? ' @ RPE ' + set.rpe : ''}`;
          ul.appendChild(li);
        });
        div.appendChild(ul);
        container.appendChild(div);
      });
    }

    document.getElementById('history-exercise-filter').addEventListener('change', updateHistory);

    // JSON Export
    document.getElementById('export-data').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'fitnotes-lite-backup.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    // JSON Import
    document.getElementById('import-data').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (evt) {
        try {
          const imported = JSON.parse(evt.target.result);
          if (imported.exercises && imported.workouts) {
            data = imported;
            saveData();
            updateAll();
            alert('Data imported.');
          } else {
            alert('Invalid backup file.');
          }
        } catch (error) {
          console.error(error);
          alert('Invalid JSON file.');
        }
      };
      reader.readAsText(file);
      // Reset input value to allow re-importing same file later
      e.target.value = '';
    });

    // CSV Import
    document.getElementById('import-csv').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (evt) {
        const text = evt.target.result;
        try {
          parseCSVAndMerge(text);
          saveData();
          updateAll();
          alert('CSV imported successfully.');
        } catch (err) {
          console.error(err);
          alert('Error importing CSV: ' + err.message);
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    });

    // Parse CSV and merge into existing data
    function parseCSVAndMerge(csvText) {
      const lines = csvText.split(/\r?\n/).filter(l => l.trim().length > 0);
      if (lines.length === 0) return;
      // Determine header indices. FitNotes export uses columns like:
      // Date,Exercise,Category,Weight,Reps,Weight Unit,...
      const header = parseCSVRow(lines[0]);
      const dateIdx = header.findIndex(h => h.toLowerCase().includes('date'));
      const exerciseIdx = header.findIndex(h => h.toLowerCase().includes('exercise'));
      const weightIdx = header.findIndex(h => h.toLowerCase().includes('weight') && !h.toLowerCase().includes('unit'));
      const repsIdx = header.findIndex(h => h.toLowerCase().includes('rep'));
      const unitIdx = header.findIndex(h => h.toLowerCase().includes('weight unit'));
      if (dateIdx < 0 || exerciseIdx < 0 || weightIdx < 0 || repsIdx < 0) {
        throw new Error('CSV missing required columns.');
      }
      for (let i = 1; i < lines.length; i++) {
        const row = parseCSVRow(lines[i]);
        if (!row || row.length === 0) continue;
        const dateVal = row[dateIdx].trim();
        const exName = row[exerciseIdx].trim();
        const weightStr = row[weightIdx].trim();
        const repsStr = row[repsIdx].trim();
        const unitStr = unitIdx >= 0 ? row[unitIdx].trim().toLowerCase() : data.settings.unit;
        if (!dateVal || !exName || !weightStr || !repsStr) continue;
        const weight = parseFloat(weightStr.replace(',', '.'));
        const reps = parseInt(repsStr);
        if (isNaN(weight) || isNaN(reps)) continue;
        // Convert weight to current unit if necessary
        let finalWeight = weight;
        if (unitStr === 'lbs' || unitStr === 'lb') {
          if (data.settings.unit === 'kg') {
            finalWeight = Math.round(weight * 0.45359237 * 10) / 10;
          }
        } else if (unitStr === 'kg') {
          if (data.settings.unit === 'lb' || data.settings.unit === 'lbs') {
            finalWeight = Math.round(weight * 2.20462262 * 10) / 10;
          }
        }
        // Find or create exercise
        let ex = data.exercises.find(e => e.name.toLowerCase() === exName.toLowerCase());
        if (!ex) {
          ex = { id: uuid(), name: exName };
          data.exercises.push(ex);
        }
        // Parse date to ISO yyyy-MM-dd
        const isoDate = formatDate(dateVal);
        // Find or create workout for this date
        let workout = data.workouts.find(w => w.date === isoDate);
        if (!workout) {
          workout = { id: uuid(), date: isoDate, notes: '', sets: [] };
          data.workouts.push(workout);
        }
        // Add set
        workout.sets.push({ id: uuid(), exerciseId: ex.id, weight: finalWeight, reps: reps });
      }
    }

    // Parse a CSV row, handling quoted commas and escaped quotes
    function parseCSVRow(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (inQuotes && line[i + 1] === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (ch === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += ch;
        }
      }
      result.push(current);
      return result;
    }

    function formatDate(dateStr) {
      // Support various date formats: yyyy-MM-dd, dd/MM/yyyy, MM/dd/yyyy, dd-MM-yyyy
      if (dateStr.includes('-')) {
        const parts = dateStr.split('-');
        if (parts.length === 3) {
          // If first part is year
          if (parts[0].length === 4) {
            return parts[0] + '-' + pad(parts[1]) + '-' + pad(parts[2]);
          }
          // dd-MM-yyyy or MM-dd-yyyy; assume dd-MM-yyyy (common in UK)
          return parts[2] + '-' + pad(parts[1]) + '-' + pad(parts[0]);
        }
      }
      const parts = dateStr.split(/[\/]/);
      if (parts.length === 3) {
        if (parts[2].length === 4) {
          // dd/MM/yyyy or MM/dd/yyyy; assume dd/MM/yyyy for UK locale
          return parts[2] + '-' + pad(parts[1]) + '-' + pad(parts[0]);
        }
        if (parts[0].length === 4) {
          // yyyy/MM/dd
          return parts[0] + '-' + pad(parts[1]) + '-' + pad(parts[2]);
        }
      }
      // fallback: return original if unknown
      return dateStr;
    }

    function pad(n) {
      return n.padStart ? n.padStart(2, '0') : ('0' + n).slice(-2);
    }

    // Reset all data
    document.getElementById('clear-data').addEventListener('click', () => {
      if (confirm('This will delete all workouts and exercises. Continue?')) {
        data = JSON.parse(JSON.stringify(defaultData));
        saveData();
        updateAll();
      }
    });

    // Tab navigation
    document.querySelectorAll('nav button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const section = btn.getAttribute('data-section');
        document.querySelectorAll('main section').forEach(sec => {
          sec.classList.add('hidden');
        });
        document.getElementById(section).classList.remove('hidden');
      });
    });

    // Initial load
    loadData();
    updateAll();
  </script>
</body>
</html>